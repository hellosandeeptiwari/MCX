<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MCX Trading Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --bg-dark: #0f0f1a;
            --bg-card: #1a1a2e;
            --bg-hover: #252540;
            --accent-blue: #00d4ff;
            --accent-green: #00ff88;
            --accent-orange: #ffa500;
            --accent-red: #ff4757;
            --accent-purple: #a855f7;
            --text-primary: #ffffff;
            --text-secondary: #8892b0;
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            background: var(--bg-dark);
            color: var(--text-primary);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            min-height: 100vh;
        }
        
        .navbar {
            background: var(--bg-card) !important;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            padding: 1rem 2rem;
        }
        
        .navbar-brand {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--accent-blue) !important;
        }
        
        .main-container {
            padding: 1.5rem;
            max-width: 1800px;
            margin: 0 auto;
        }
        
        .card {
            background: var(--bg-card);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 12px;
            margin-bottom: 1rem;
        }
        
        .card-header {
            background: transparent;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            padding: 0.75rem 1rem;
            font-weight: 600;
            color: var(--text-secondary);
            font-size: 0.9rem;
        }
        
        .card-body { padding: 1rem; }
        
        .price-card {
            text-align: center;
            padding: 1rem;
        }
        
        .price-label {
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-bottom: 0.25rem;
        }
        
        .price-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: #ffffff;
        }
        
        .price-change {
            font-size: 0.85rem;
            margin-top: 0.25rem;
        }
        
        .price-change.positive { color: var(--accent-green); }
        .price-change.negative { color: var(--accent-red); }
        
        .signal-badge {
            font-size: 1.25rem;
            padding: 0.5rem 1.5rem;
            border-radius: 50px;
            font-weight: 700;
            display: inline-block;
        }
        
        .signal-badge.success {
            background: rgba(0, 255, 136, 0.2);
            color: var(--accent-green);
            border: 2px solid var(--accent-green);
        }
        
        .signal-badge.danger {
            background: rgba(255, 71, 87, 0.2);
            color: var(--accent-red);
            border: 2px solid var(--accent-red);
        }
        
        .signal-badge.warning {
            background: rgba(255, 165, 0, 0.2);
            color: var(--accent-orange);
            border: 2px solid var(--accent-orange);
        }
        
        .metric-row {
            display: flex;
            justify-content: space-between;
            padding: 0.5rem 0;
            border-bottom: 1px solid rgba(255,255,255,0.05);
            font-size: 0.85rem;
        }
        
        .metric-row:last-child { border-bottom: none; }
        .metric-label { color: var(--text-secondary); }
        .metric-value { font-weight: 600; color: #ffffff; }
        
        .chart-container {
            background: var(--bg-dark);
            border-radius: 8px;
            padding: 0.5rem;
            text-align: center;
        }
        
        .chart-container img {
            max-width: 100%;
            height: auto;
            border-radius: 8px;
        }
        
        .option-chain-table {
            width: 100%;
            font-size: 0.8rem;
        }
        
        .option-chain-table th {
            background: var(--bg-hover);
            padding: 0.5rem;
            text-align: center;
            color: #ffffff;
            font-weight: 600;
            position: sticky;
            top: 0;
        }
        
        .option-chain-table td {
            padding: 0.4rem;
            text-align: center;
            border-bottom: 1px solid rgba(255,255,255,0.05);
            color: #ffffff;
        }
        
        .option-chain-table tr:hover { background: var(--bg-hover); }
        .option-chain-table .call-side { background: rgba(0, 255, 136, 0.05); }
        .option-chain-table .put-side { background: rgba(255, 71, 87, 0.05); }
        .option-chain-table .strike-col {
            background: var(--bg-hover);
            font-weight: 700;
            color: var(--accent-blue);
        }
        .option-chain-table .atm-row {
            background: rgba(0, 212, 255, 0.1) !important;
            border: 1px solid var(--accent-blue);
        }
        
        .strategy-card {
            background: linear-gradient(135deg, var(--bg-card) 0%, var(--bg-hover) 100%);
            border: 2px solid var(--accent-blue);
        }
        
        .strategy-name {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--accent-blue);
            margin-bottom: 0.5rem;
        }
        
        .btn-refresh {
            background: var(--accent-blue);
            border: none;
            color: var(--bg-dark);
            font-weight: 600;
            padding: 0.4rem 1rem;
            border-radius: 8px;
            font-size: 0.85rem;
        }
        
        .btn-refresh:hover {
            background: var(--accent-green);
        }
        
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 2rem;
        }
        
        .loading-spinner {
            width: 30px;
            height: 30px;
            border: 3px solid rgba(255,255,255,0.1);
            border-top-color: var(--accent-blue);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin { to { transform: rotate(360deg); } }
        
        .indicator-box {
            background: var(--bg-hover);
            border-radius: 8px;
            padding: 0.75rem;
            text-align: center;
            margin-bottom: 0.5rem;
        }
        
        .indicator-label {
            font-size: 0.7rem;
            color: var(--text-secondary);
            text-transform: uppercase;
        }
        
        .indicator-value {
            font-size: 1.1rem;
            font-weight: 700;
            color: #ffffff;
        }
        
        .indicator-signal {
            font-size: 0.7rem;
            padding: 0.15rem 0.5rem;
            border-radius: 10px;
            display: inline-block;
            margin-top: 0.25rem;
        }
        
        .bullish { background: rgba(0,255,136,0.2); color: var(--accent-green); }
        .bearish { background: rgba(255,71,87,0.2); color: var(--accent-red); }
        .neutral { background: rgba(255,165,0,0.2); color: var(--accent-orange); }
        
        .support-resistance {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }
        
        .sr-level {
            display: flex;
            justify-content: space-between;
            padding: 0.4rem 0.75rem;
            border-radius: 4px;
            font-size: 0.8rem;
            color: #ffffff;
        }
        
        .sr-resistance { background: rgba(255,71,87,0.1); border-left: 3px solid var(--accent-red); }
        .sr-pivot { background: rgba(0,212,255,0.1); border-left: 3px solid var(--accent-blue); }
        .sr-support { background: rgba(0,255,136,0.1); border-left: 3px solid var(--accent-green); }
        .sr-current { background: rgba(168,85,247,0.2); border-left: 3px solid var(--accent-purple); font-weight: 700; }
        
        .form-control-dark {
            background: var(--bg-hover);
            border: 1px solid rgba(255,255,255,0.1);
            color: white;
            font-size: 0.85rem;
        }
        
        .form-control-dark:focus {
            background: var(--bg-hover);
            border-color: var(--accent-blue);
            color: white;
            box-shadow: none;
        }
        
        .btn-calculate {
            background: var(--accent-purple);
            border: none;
            color: white;
            font-weight: 600;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            width: 100%;
            margin-top: 0.5rem;
        }
        
        .result-box {
            background: var(--bg-hover);
            border-radius: 8px;
            padding: 1rem;
            margin-top: 1rem;
        }
        
        .pnl-positive { color: var(--accent-green); font-weight: 700; }
        .pnl-negative { color: var(--accent-red); font-weight: 700; }
        
        .table-responsive { max-height: 350px; overflow-y: auto; }
        
        .pre-market-item {
            display: flex;
            justify-content: space-between;
            padding: 0.4rem 0;
            font-size: 0.85rem;
            color: var(--text-secondary);
        }
        
        .pre-market-item strong {
            color: #ffffff;
        }
        
        .overnight-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
        }
        
        footer {
            text-align: center;
            padding: 1rem;
            color: var(--text-secondary);
            font-size: 0.75rem;
        }
        
        .lot-info {
            background: rgba(168,85,247,0.1);
            border: 1px solid var(--accent-purple);
            border-radius: 8px;
            padding: 0.5rem;
            text-align: center;
            margin-bottom: 1rem;
        }
        
        /* Tooltip styles */
        .info-tip {
            position: relative;
            display: inline-block;
            cursor: help;
            margin-left: 4px;
        }
        
        .info-tip i {
            font-size: 0.7rem;
            color: var(--accent-blue);
            opacity: 0.7;
        }
        
        .info-tip:hover i {
            opacity: 1;
        }
        
        .info-tip .tooltip-text {
            visibility: hidden;
            width: 280px;
            background-color: #1a1a2e;
            color: #fff;
            text-align: left;
            border-radius: 8px;
            padding: 10px 12px;
            position: absolute;
            z-index: 1000;
            bottom: 125%;
            left: 50%;
            margin-left: -140px;
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 0.75rem;
            line-height: 1.4;
            border: 1px solid var(--accent-blue);
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }
        
        .info-tip .tooltip-text::after {
            content: "";
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -6px;
            border-width: 6px;
            border-style: solid;
            border-color: var(--accent-blue) transparent transparent transparent;
        }
        
        .info-tip:hover .tooltip-text {
            visibility: visible;
            opacity: 1;
        }
        
        .tooltip-title {
            color: var(--accent-blue);
            font-weight: 600;
            margin-bottom: 4px;
        }
    </style>
</head>
<body>
    <nav class="navbar">
        <div class="container-fluid">
            <span class="navbar-brand">
                <i class="fas fa-chart-line"></i> MCX Trading Dashboard
                <span class="info-tip" style="font-size: 0.7rem; margin-left: 10px;"><i class="fas fa-question-circle" style="color: var(--accent-purple);"></i>
                    <span class="tooltip-text" style="width: 400px;"><span class="tooltip-title">üè¢ What is MCX Ltd?</span><br><br>
                    <b>MCX Ltd (NSE: MCX)</b> is the company that OWNS and OPERATES India's largest commodity exchange.<br><br>
                    <b>‚ö° KEY INSIGHT:</b><br>
                    MCX is an <b>EXCHANGE</b>, not a commodity!<br><br>
                    <span style="color: #22c55e;">‚úì MCX earns TRANSACTION FEES from every trade</span><br>
                    <span style="color: #22c55e;">‚úì More VOLATILITY = More trading = More fees</span><br>
                    <span style="color: #22c55e;">‚úì Direction doesn't matter - ACTIVITY does!</span><br><br>
                    <b>Example:</b> If Gold crashes 5%, traders panic and trade MORE. MCX earns MORE fees!<br><br>
                    <b>That's why MCX can go UP even when commodities go DOWN!</b>
                    </span>
                </span>
            </span>
            <div>
                <span class="text-secondary me-2" style="font-size: 0.8rem;" id="lastUpdate">--</span>
                <button class="btn-refresh" onclick="refreshAll()">
                    <i class="fas fa-sync-alt me-1"></i>Refresh
                </button>
            </div>
        </div>
    </nav>

    <div class="main-container">
        <!-- IMPORTANT EXPLAINER BANNER -->
        <div class="alert mb-3" style="background: linear-gradient(135deg, rgba(168,85,247,0.2), rgba(0,212,255,0.2)); border: 1px solid var(--accent-purple); border-radius: 10px;">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h5 style="color: var(--accent-purple); margin-bottom: 8px;">
                        <i class="fas fa-lightbulb me-2"></i>Understanding MCX Stock vs Commodities
                    </h5>
                    <p style="margin-bottom: 0; font-size: 0.85rem; color: var(--text-secondary);">
                        <b style="color: #fff;">MCX Ltd</b> is the <b>EXCHANGE</b> where commodities are traded. 
                        It earns fees from every transaction. High <b>VOLATILITY</b> in commodities (Gold, Silver, Oil, Gas) 
                        ‚Üí More traders entering/exiting ‚Üí More volume ‚Üí <b>More revenue for MCX</b>. 
                        That's why MCX stock can rise even when commodity prices fall!
                    </p>
                </div>
                <div class="col-md-4 text-center">
                    <div style="font-size: 0.75rem; color: var(--text-secondary);">Trading Logic:</div>
                    <div style="font-size: 0.9rem; font-weight: 600;">
                        <span style="color: #ef4444;">High Volatility</span> = 
                        <span style="color: #22c55e;">MCX Bullish</span> üìà
                    </div>
                    <div style="font-size: 0.9rem; font-weight: 600;">
                        <span style="color: #3b82f6;">Low Volatility</span> = 
                        <span style="color: #ef4444;">MCX Bearish</span> üìâ
                    </div>
                </div>
            </div>
        </div>

        <!-- Top Row - Key Metrics -->
        <div class="row">
            <div class="col-lg-2 col-md-4 col-6">
                <div class="card">
                    <div class="price-card">
                        <div class="price-label"><i class="fas fa-building me-1"></i>MCX Ltd
                            <span class="info-tip"><i class="fas fa-info-circle"></i>
                                <span class="tooltip-text"><span class="tooltip-title">MCX Ltd (NSE: MCX)</span><br>Multi Commodity Exchange of India Ltd. The company that RUNS India's largest commodity exchange. <br><br><b>Revenue = Transaction fees from trading volume.</b><br><br>More volatility ‚Üí More trading ‚Üí More revenue!</span>
                            </span>
                        </div>
                        <div class="price-value" id="mcxPrice">--</div>
                        <div class="price-change" id="mcxChange">--</div>
                    </div>
                </div>
            </div>
            <div class="col-lg-2 col-md-4 col-6">
                <div class="card">
                    <div class="price-card">
                        <div class="price-label"><i class="fas fa-cubes me-1"></i>Composite Index
                            <span class="info-tip"><i class="fas fa-info-circle"></i>
                                <span class="tooltip-text"><span class="tooltip-title">Weighted Commodity Index</span><br>Composite of ALL commodities weighted by MCX trading volume:<br><br>ü•á Gold: 35%<br>ü•à Silver: 25%<br>üõ¢Ô∏è Crude: 20%<br>üî• Gas: 10%<br>üîß Metals: 10%<br><br>This better reflects MCX revenue drivers!</span>
                            </span>
                        </div>
                        <div class="price-value" id="metalPrice">--</div>
                        <div class="price-change" id="metalChange">--</div>
                    </div>
                </div>
            </div>
            <div class="col-lg-2 col-md-4 col-6">
                <div class="card" style="border: 1px solid var(--accent-purple);">
                    <div class="price-card">
                        <div class="price-label"><i class="fas fa-fire-alt me-1" style="color: var(--accent-purple);"></i>Commodity Vol
                            <span class="info-tip"><i class="fas fa-info-circle"></i>
                                <span class="tooltip-text"><span class="tooltip-title">‚ö° THE KEY DRIVER!</span><br>This is what actually drives MCX stock!<br><br><b>High Vol (>30%)</b> = More trading = MCX UP üìà<br><b>Low Vol (<20%)</b> = Less trading = MCX DOWN üìâ<br><br>MCX earns FEES from trading volume. Volatility drives volume!</span>
                            </span>
                        </div>
                        <div class="price-value" id="compositeVolTop">--</div>
                        <div class="indicator-signal" id="volSignalTop">--</div>
                    </div>
                </div>
            </div>
            <div class="col-lg-2 col-md-4 col-6">
                <div class="card" style="border: 1px solid var(--accent-blue);">
                    <div class="price-card">
                        <div class="price-label"><i class="fas fa-chart-bar me-1" style="color: var(--accent-blue);"></i>MCX Volume
                            <span class="info-tip"><i class="fas fa-info-circle"></i>
                                <span class="tooltip-text"><span class="tooltip-title">Trading Volume Ratio</span><br>Today's volume vs 20-day average.<br><br><b>>1.5x</b> = High activity = Good for MCX üìà<br><b><0.7x</b> = Low activity = Bad for MCX üìâ<br><br>Volume spike = potential price move!</span>
                            </span>
                        </div>
                        <div class="price-value" id="volumeRatioTop">--</div>
                        <div class="indicator-signal" id="volumeTrendTop">--</div>
                    </div>
                </div>
            </div>
            <div class="col-lg-2 col-md-4 col-6">
                <div class="card">
                    <div class="price-card">
                        <div class="price-label"><i class="fas fa-tachometer-alt me-1"></i>RSI (14)
                            <span class="info-tip"><i class="fas fa-info-circle"></i>
                                <span class="tooltip-text"><span class="tooltip-title">Relative Strength Index</span><br>Momentum indicator (0-100).<br><br><b>Below 30</b> = Oversold (may bounce up)<br><b>Above 70</b> = Overbought (may fall)<br><b>30-70</b> = Neutral zone<br><br>14-day period is standard.</span>
                            </span>
                        </div>
                        <div class="price-value" id="rsiValue">--</div>
                        <div class="indicator-signal" id="rsiSignal">--</div>
                    </div>
                </div>
            </div>
            <div class="col-lg-2 col-md-4 col-6">
                <div class="card">
                    <div class="price-card">
                        <div class="price-label"><i class="fas fa-bolt me-1"></i>MCX Stock Vol
                            <span class="info-tip"><i class="fas fa-info-circle"></i>
                                <span class="tooltip-text"><span class="tooltip-title">MCX Stock Volatility</span><br>How much MCX stock price swings (annualized %).<br><br><b>High Vol (>40%)</b> = Big swings, expensive options<br><b>Low Vol (<25%)</b> = Calm, cheap options<br><br>Higher volatility = Higher option premiums.</span>
                            </span>
                        </div>
                        <div class="price-value" id="volatility">--</div>
                        <div class="price-change" id="expectedMove">--</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- KEY INSIGHT: Volatility Index Row -->
        <div class="card mb-3" style="border: 2px solid var(--accent-purple);">
            <div class="card-header" style="background: rgba(168,85,247,0.1);">
                <i class="fas fa-fire-alt me-2" style="color: var(--accent-purple);"></i>
                <strong style="color: var(--accent-purple);">‚ö° VOLATILITY INDEX - THE KEY METRIC!</strong>
                <span class="info-tip"><i class="fas fa-info-circle"></i>
                    <span class="tooltip-text"><span class="tooltip-title">Why Volatility Matters</span><br><b>MCX is an EXCHANGE, not a commodity!</b><br><br>MCX earns from TRADING VOLUME.<br><br>High commodity volatility ‚Üí More trading ‚Üí More fees ‚Üí MCX stock UP!<br><br>Direction doesn't matter - VOLATILITY does!</span>
                </span>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3 text-center">
                        <div style="font-size: 0.75rem; color: var(--text-secondary);">Composite Volatility</div>
                        <div style="font-size: 2rem; font-weight: 700;" id="compositeVol">--</div>
                        <div class="indicator-signal" id="volSignal">--</div>
                    </div>
                    <div class="col-md-3 text-center">
                        <div style="font-size: 0.75rem; color: var(--text-secondary);">MCX Outlook</div>
                        <div style="font-size: 1.5rem; font-weight: 700;" id="mcxOutlook">--</div>
                        <div style="font-size: 0.7rem; color: var(--text-secondary);">Based on Volatility</div>
                    </div>
                    <div class="col-md-3 text-center">
                        <div style="font-size: 0.75rem; color: var(--text-secondary);">MCX Volume Today</div>
                        <div style="font-size: 1.5rem; font-weight: 700;" id="mcxVolume">--</div>
                        <div class="indicator-signal" id="volumeSpike">--</div>
                    </div>
                    <div class="col-md-3 text-center">
                        <div style="font-size: 0.75rem; color: var(--text-secondary);">Volume vs 20D Avg</div>
                        <div style="font-size: 1.5rem; font-weight: 700;" id="volumeRatioNew">--</div>
                        <div class="indicator-signal" id="volumeTrend">--</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Commodities Row with Volatility -->
        <div class="card mb-3">
            <div class="card-header">
                <i class="fas fa-coins me-2"></i>Commodity Volatility Breakdown
                <span class="info-tip"><i class="fas fa-info-circle"></i>
                    <span class="tooltip-text"><span class="tooltip-title">Volatility = Trading Activity!</span><br>High volatility in any commodity drives MCX volumes.<br><br>üî¥ RISING vol = More trading expected<br>üü¢ STABLE vol = Normal trading<br>üîµ FALLING vol = Less activity<br><br>Watch for volatility SPIKES!</span>
                </span>
            </div>
            <div class="card-body">
                <div class="row" id="commoditiesRow">
                    <div class="col">
                        <div class="indicator-box">
                            <div class="indicator-label">ü•á Gold (35%)</div>
                            <div class="indicator-value" id="goldPrice">--</div>
                            <div class="indicator-signal" id="goldChange">--</div>
                            <div style="font-size: 0.65rem; margin-top: 4px; color: var(--text-secondary);">Vol: <span id="goldVol">--</span></div>
                        </div>
                    </div>
                    <div class="col">
                        <div class="indicator-box">
                            <div class="indicator-label">ü•à Silver (25%)</div>
                            <div class="indicator-value" id="silverPrice">--</div>
                            <div class="indicator-signal" id="silverChange">--</div>
                            <div style="font-size: 0.65rem; margin-top: 4px; color: var(--text-secondary);">Vol: <span id="silverVol">--</span></div>
                        </div>
                    </div>
                    <div class="col">
                        <div class="indicator-box">
                            <div class="indicator-label">üõ¢Ô∏è Crude Oil (20%)</div>
                            <div class="indicator-value" id="oilPrice">--</div>
                            <div class="indicator-signal" id="oilChange">--</div>
                            <div style="font-size: 0.65rem; margin-top: 4px; color: var(--text-secondary);">Vol: <span id="oilVol">--</span></div>
                        </div>
                    </div>
                    <div class="col">
                        <div class="indicator-box">
                            <div class="indicator-label">üî• Natural Gas (10%)</div>
                            <div class="indicator-value" id="gasPrice">--</div>
                            <div class="indicator-signal" id="gasChange">--</div>
                            <div style="font-size: 0.65rem; margin-top: 4px; color: var(--text-secondary);">Vol: <span id="gasVol">--</span></div>
                        </div>
                    </div>
                    <div class="col">
                        <div class="indicator-box">
                            <div class="indicator-label">üîß Base Metals (10%)</div>
                            <div class="indicator-value" id="baseMetalPrice">--</div>
                            <div class="indicator-signal" id="baseMetalChange">--</div>
                            <div style="font-size: 0.65rem; margin-top: 4px; color: var(--text-secondary);">Vol: <span id="metalVol">--</span></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Content Row -->
        <div class="row">
            <!-- Left Column - Charts & Option Chain -->
            <div class="col-lg-8">
                <!-- Pre-Market Summary -->
                <div class="card">
                    <div class="card-header">
                        <i class="fas fa-sun me-2"></i>Pre-Market Summary
                    </div>
                    <div class="card-body">
                        <div class="row" id="preMarketContent">
                            <div class="col-md-3">
                                <div class="pre-market-item">
                                    <span>Prev Close</span>
                                    <strong id="prevClose">--</strong>
                                </div>
                                <div class="pre-market-item">
                                    <span>Prev High</span>
                                    <strong id="prevHigh">--</strong>
                                </div>
                                <div class="pre-market-item">
                                    <span>Prev Low</span>
                                    <strong id="prevLow">--</strong>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="pre-market-item">
                                    <span>Weekly Chg</span>
                                    <strong id="weeklyChange">--</strong>
                                </div>
                                <div class="pre-market-item">
                                    <span>Monthly Chg</span>
                                    <strong id="monthlyChange">--</strong>
                                </div>
                                <div class="pre-market-item">
                                    <span>Metal O/N</span>
                                    <strong id="metalOvernight">--</strong>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="pre-market-item">
                                    <span>52W High</span>
                                    <strong id="high52w">--</strong>
                                </div>
                                <div class="pre-market-item">
                                    <span>From 52W High</span>
                                    <strong id="from52wHigh">--</strong>
                                </div>
                                <div class="pre-market-item">
                                    <span>From 52W Low</span>
                                    <strong id="from52wLow">--</strong>
                                </div>
                            </div>
                            <div class="col-md-3 text-center">
                                <div class="overnight-badge" id="divergenceBadge">--</div>
                                <div class="mt-2" style="font-size: 0.75rem; color: var(--text-secondary);">
                                    MCX vs Metals Overnight
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Price Chart -->
                <div class="card">
                    <div class="card-header"><i class="fas fa-chart-area me-2"></i>Price Comparison</div>
                    <div class="card-body">
                        <div class="chart-container" id="priceChart">
                            <div class="loading"><div class="loading-spinner"></div></div>
                        </div>
                    </div>
                </div>

                <!-- Option Chain -->
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <span><i class="fas fa-table me-2"></i>Option Chain (Lot Size: 625)
                            <span class="info-tip"><i class="fas fa-info-circle"></i>
                                <span class="tooltip-text"><span class="tooltip-title">Option Chain</span><br>Shows theoretical prices for Calls & Puts.<br><br><b>Delta</b> = Price change per ‚Çπ1 stock move<br><b>Gamma</b> = Delta change rate<br><b>Theta</b> = Daily time decay (negative)<br><b>Vega</b> = Sensitivity to volatility<br><br>ATM = At-the-money (highlighted)</span>
                            </span>
                        </span>
                        <select class="form-select form-select-sm form-control-dark" id="expirySelect" style="width: auto;">
                            <option value="7">7 Days</option>
                            <option value="15">15 Days</option>
                            <option value="30" selected>30 Days</option>
                            <option value="45">45 Days</option>
                        </select>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive" id="optionChainContainer">
                            <div class="loading"><div class="loading-spinner"></div></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Column - Strategy & Tools -->
            <div class="col-lg-4">
                <!-- Strategy Recommendation -->
                <div class="card strategy-card">
                    <div class="card-header"><i class="fas fa-lightbulb me-2"></i>Recommended Strategy
                        <span class="info-tip"><i class="fas fa-info-circle"></i>
                            <span class="tooltip-text"><span class="tooltip-title">Strategy Based on Z-Score</span><br><b>BEAR PUT SPREAD</b> = Buy high strike Put, sell low strike Put (bearish)<br><b>BULL CALL SPREAD</b> = Buy low strike Call, sell high strike Call (bullish)<br><b>NAKED PUT</b> = Sell Put, collect premium (bullish)<br><br>Confidence: HIGH/MEDIUM/LOW based on Z-score strength.</span>
                        </span>
                    </div>
                    <div class="card-body" id="strategyContent">
                        <div class="loading"><div class="loading-spinner"></div></div>
                    </div>
                </div>

                <!-- Support & Resistance -->
                <div class="card">
                    <div class="card-header"><i class="fas fa-arrows-alt-v me-2"></i>Support & Resistance
                        <span class="info-tip"><i class="fas fa-info-circle"></i>
                            <span class="tooltip-text"><span class="tooltip-title">Pivot Points</span><br><b>R2, R1</b> = Resistance levels (price struggles to break above)<br><b>Pivot</b> = Balance point<br><b>S1, S2</b> = Support levels (buyers step in)<br><br>Use for setting stop-loss and targets.</span>
                        </span>
                    </div>
                    <div class="card-body">
                        <div class="support-resistance" id="srLevels">
                            <div class="loading"><div class="loading-spinner"></div></div>
                        </div>
                    </div>
                </div>

                <!-- Technical Indicators -->
                <div class="card">
                    <div class="card-header"><i class="fas fa-wave-square me-2"></i>Technical Indicators
                        <span class="info-tip"><i class="fas fa-info-circle"></i>
                            <span class="tooltip-text"><span class="tooltip-title">Technical Analysis</span><br>Indicators help predict price direction.<br><br><b>MACD</b> = Trend momentum<br><b>BB</b> = Overbought/oversold<br><b>SMA</b> = Trend direction<br><b>Volume</b> = Trading activity</span>
                        </span>
                    </div>
                    <div class="card-body">
                        <div class="row" id="technicalIndicators">
                            <div class="col-6">
                                <div class="indicator-box">
                                    <div class="indicator-label">MACD
                                        <span class="info-tip"><i class="fas fa-info-circle"></i>
                                            <span class="tooltip-text"><span class="tooltip-title">MACD</span><br>Moving Average Convergence Divergence.<br><br><b>Positive + Bullish</b> = Uptrend<br><b>Negative + Bearish</b> = Downtrend<br><br>Crossovers signal trend changes.</span>
                                        </span>
                                    </div>
                                    <div class="indicator-value" id="macdValue">--</div>
                                    <div class="indicator-signal" id="macdSignal">--</div>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="indicator-box">
                                    <div class="indicator-label">BB Position
                                        <span class="info-tip"><i class="fas fa-info-circle"></i>
                                            <span class="tooltip-text"><span class="tooltip-title">Bollinger Bands</span><br>Shows if price is at extremes.<br><br><b>UPPER</b> = Near top band (overbought)<br><b>MIDDLE</b> = Normal<br><b>LOWER</b> = Near bottom band (oversold)<br><br>Price often bounces from bands.</span>
                                        </span>
                                    </div>
                                    <div class="indicator-value" id="bbValue">--</div>
                                    <div class="indicator-signal" id="bbSignal">--</div>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="indicator-box">
                                    <div class="indicator-label">SMA Trend
                                        <span class="info-tip"><i class="fas fa-info-circle"></i>
                                            <span class="tooltip-text"><span class="tooltip-title">SMA Trend</span><br>Price vs 50-day Simple Moving Average.<br><br><b>BULLISH</b> = Price above SMA50 (uptrend)<br><b>BEARISH</b> = Price below SMA50 (downtrend)<br><br>SMA acts as dynamic support/resistance.</span>
                                        </span>
                                    </div>
                                    <div class="indicator-value" id="smaValue">--</div>
                                    <div class="indicator-signal" id="smaSignal">--</div>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="indicator-box">
                                    <div class="indicator-label">Volume
                                        <span class="info-tip"><i class="fas fa-info-circle"></i>
                                            <span class="tooltip-text"><span class="tooltip-title">Volume Ratio</span><br>Today's volume vs 20-day average.<br><br><b>>1.5x HIGH</b> = Strong interest<br><b>0.7-1.5x NORMAL</b> = Average<br><b><0.7x LOW</b> = Low interest<br><br>High volume confirms price moves.</span>
                                        </span>
                                    </div>
                                    <div class="indicator-value" id="volumeValue">--</div>
                                    <div class="indicator-signal" id="volumeSignal">--</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- P&L Simulator -->
                <div class="card">
                    <div class="card-header"><i class="fas fa-calculator me-2"></i>P&L Simulator (Naked Put)
                        <span class="info-tip"><i class="fas fa-info-circle"></i>
                            <span class="tooltip-text"><span class="tooltip-title">Naked Put Strategy</span><br>SELL a Put option to collect premium.<br><br><b>Profit</b> = Keep premium if stock stays above strike<br><b>Risk</b> = Must buy stock at strike if it falls<br><b>Breakeven</b> = Strike - Premium<br><br>Bullish to neutral strategy.</span>
                        </span>
                    </div>
                    <div class="card-body">
                        <div class="lot-info">
                            <i class="fas fa-info-circle me-1"></i>
                            MCX Lot Size: <strong>625 shares</strong>
                        </div>
                        <div class="row g-2">
                            <div class="col-6">
                                <label class="form-label" style="font-size: 0.75rem;">Strike Price</label>
                                <input type="number" class="form-control form-control-sm form-control-dark" id="simStrike" value="2320">
                            </div>
                            <div class="col-6">
                                <label class="form-label" style="font-size: 0.75rem;">Premium (‚Çπ)</label>
                                <input type="number" class="form-control form-control-sm form-control-dark" id="simPremium" value="80">
                            </div>
                            <div class="col-6">
                                <label class="form-label" style="font-size: 0.75rem;">No. of Lots</label>
                                <input type="number" class="form-control form-control-sm form-control-dark" id="simLots" value="1">
                            </div>
                            <div class="col-6">
                                <label class="form-label" style="font-size: 0.75rem;">Option Type</label>
                                <select class="form-select form-select-sm form-control-dark" id="simType">
                                    <option value="PUT" selected>PUT</option>
                                    <option value="CALL">CALL</option>
                                </select>
                            </div>
                        </div>
                        <button class="btn-calculate" onclick="simulatePnL()">
                            <i class="fas fa-play me-1"></i>Calculate P&L
                        </button>
                        <div class="result-box" id="pnlResult" style="display: none;">
                            <div class="row text-center">
                                <div class="col-4">
                                    <div style="font-size: 0.7rem; color: var(--text-secondary);">Breakeven</div>
                                    <div class="pnl-positive" id="breakeven">--</div>
                                </div>
                                <div class="col-4">
                                    <div style="font-size: 0.7rem; color: var(--text-secondary);">Max Loss</div>
                                    <div class="pnl-negative" id="maxLoss">--</div>
                                </div>
                                <div class="col-4">
                                    <div style="font-size: 0.7rem; color: var(--text-secondary);">Total Shares</div>
                                    <div id="totalShares">--</div>
                                </div>
                            </div>
                            <hr style="border-color: rgba(255,255,255,0.1);">
                            <div style="font-size: 0.75rem; color: var(--text-secondary);">P&L at Different Prices:</div>
                            <div id="pnlTable" style="max-height: 150px; overflow-y: auto;"></div>
                        </div>
                    </div>
                </div>

                <!-- Position Size Calculator -->
                <div class="card">
                    <div class="card-header"><i class="fas fa-balance-scale me-2"></i>Position Size Calculator
                        <span class="info-tip"><i class="fas fa-info-circle"></i>
                            <span class="tooltip-text"><span class="tooltip-title">Position Sizing</span><br>Calculate how many lots to trade based on risk.<br><br><b>Risk %</b> = Max % of capital to risk per trade (1-2% recommended)<br><b>Stop Loss</b> = Price where you exit if wrong<br><br>Never risk more than you can afford to lose!</span>
                        </span>
                    </div>
                    <div class="card-body">
                        <div class="row g-2">
                            <div class="col-6">
                                <label class="form-label" style="font-size: 0.75rem;">Capital (‚Çπ)</label>
                                <input type="number" class="form-control form-control-sm form-control-dark" id="posCapital" value="500000">
                            </div>
                            <div class="col-6">
                                <label class="form-label" style="font-size: 0.75rem;">Risk %</label>
                                <input type="number" class="form-control form-control-sm form-control-dark" id="posRisk" value="2" step="0.5">
                            </div>
                            <div class="col-6">
                                <label class="form-label" style="font-size: 0.75rem;">Entry Price</label>
                                <input type="number" class="form-control form-control-sm form-control-dark" id="posEntry" value="2320">
                            </div>
                            <div class="col-6">
                                <label class="form-label" style="font-size: 0.75rem;">Stop Loss</label>
                                <input type="number" class="form-control form-control-sm form-control-dark" id="posStop" value="2200">
                            </div>
                        </div>
                        <button class="btn-calculate" onclick="calculatePosition()" style="background: var(--accent-orange);">
                            <i class="fas fa-calculator me-1"></i>Calculate Size
                        </button>
                        <div class="result-box" id="positionResult" style="display: none;">
                            <div class="metric-row">
                                <span class="metric-label">Risk Amount</span>
                                <span class="metric-value" id="riskAmount">--</span>
                            </div>
                            <div class="metric-row">
                                <span class="metric-label">Recommended Lots</span>
                                <span class="metric-value" id="recLots">--</span>
                            </div>
                            <div class="metric-row">
                                <span class="metric-label">Total Shares</span>
                                <span class="metric-value" id="recShares">--</span>
                            </div>
                            <div class="metric-row">
                                <span class="metric-label">Capital Required</span>
                                <span class="metric-value" id="capRequired">--</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Correlation Chart -->
                <div class="card">
                    <div class="card-header"><i class="fas fa-project-diagram me-2"></i>Rolling Correlation</div>
                    <div class="card-body">
                        <div class="chart-container" id="correlationChart">
                            <div class="loading"><div class="loading-spinner"></div></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <footer>
        <p>MCX Trading Dashboard | Lot Size: 625 shares | Data: Yahoo Finance | For educational purposes only</p>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const LOT_SIZE = 625;

        async function fetchCommodities() {
            try {
                const response = await fetch('/api/commodities');
                const result = await response.json();
                if (result.success) {
                    const data = result.data;
                    
                    // Gold
                    if (data['Gold (GLD)']) {
                        document.getElementById('goldPrice').textContent = '$' + data['Gold (GLD)'].price.toFixed(2);
                        const goldChange = document.getElementById('goldChange');
                        goldChange.textContent = (data['Gold (GLD)'].change >= 0 ? '+' : '') + data['Gold (GLD)'].change.toFixed(2) + '%';
                        goldChange.className = 'indicator-signal ' + (data['Gold (GLD)'].change >= 0 ? 'bullish' : 'bearish');
                        // Volatility display
                        if (data['Gold (GLD)'].volatility) {
                            const goldVolEl = document.getElementById('goldVol');
                            const vol = data['Gold (GLD)'].volatility;
                            const trend = data['Gold (GLD)'].vol_trend || 'STABLE';
                            goldVolEl.innerHTML = vol.toFixed(1) + '% <span style="color:' + getVolTrendColor(trend) + ';">' + getVolTrendIcon(trend) + '</span>';
                        }
                    }
                    
                    // Silver
                    if (data['Silver (SLV)']) {
                        document.getElementById('silverPrice').textContent = '$' + data['Silver (SLV)'].price.toFixed(2);
                        const silverChange = document.getElementById('silverChange');
                        silverChange.textContent = (data['Silver (SLV)'].change >= 0 ? '+' : '') + data['Silver (SLV)'].change.toFixed(2) + '%';
                        silverChange.className = 'indicator-signal ' + (data['Silver (SLV)'].change >= 0 ? 'bullish' : 'bearish');
                        if (data['Silver (SLV)'].volatility) {
                            const silverVolEl = document.getElementById('silverVol');
                            const vol = data['Silver (SLV)'].volatility;
                            const trend = data['Silver (SLV)'].vol_trend || 'STABLE';
                            silverVolEl.innerHTML = vol.toFixed(1) + '% <span style="color:' + getVolTrendColor(trend) + ';">' + getVolTrendIcon(trend) + '</span>';
                        }
                    }
                    
                    // Crude Oil
                    if (data['Crude Oil (USO)']) {
                        document.getElementById('oilPrice').textContent = '$' + data['Crude Oil (USO)'].price.toFixed(2);
                        const oilChange = document.getElementById('oilChange');
                        oilChange.textContent = (data['Crude Oil (USO)'].change >= 0 ? '+' : '') + data['Crude Oil (USO)'].change.toFixed(2) + '%';
                        oilChange.className = 'indicator-signal ' + (data['Crude Oil (USO)'].change >= 0 ? 'bullish' : 'bearish');
                        if (data['Crude Oil (USO)'].volatility) {
                            const oilVolEl = document.getElementById('oilVol');
                            const vol = data['Crude Oil (USO)'].volatility;
                            const trend = data['Crude Oil (USO)'].vol_trend || 'STABLE';
                            oilVolEl.innerHTML = vol.toFixed(1) + '% <span style="color:' + getVolTrendColor(trend) + ';">' + getVolTrendIcon(trend) + '</span>';
                        }
                    }
                    
                    // Natural Gas
                    if (data['Natural Gas (UNG)']) {
                        document.getElementById('gasPrice').textContent = '$' + data['Natural Gas (UNG)'].price.toFixed(2);
                        const gasChange = document.getElementById('gasChange');
                        gasChange.textContent = (data['Natural Gas (UNG)'].change >= 0 ? '+' : '') + data['Natural Gas (UNG)'].change.toFixed(2) + '%';
                        gasChange.className = 'indicator-signal ' + (data['Natural Gas (UNG)'].change >= 0 ? 'bullish' : 'bearish');
                        if (data['Natural Gas (UNG)'].volatility) {
                            const gasVolEl = document.getElementById('gasVol');
                            const vol = data['Natural Gas (UNG)'].volatility;
                            const trend = data['Natural Gas (UNG)'].vol_trend || 'STABLE';
                            gasVolEl.innerHTML = vol.toFixed(1) + '% <span style="color:' + getVolTrendColor(trend) + ';">' + getVolTrendIcon(trend) + '</span>';
                        }
                    }
                    
                    // Base Metals
                    if (data['Base Metals (DBB)']) {
                        document.getElementById('baseMetalPrice').textContent = '$' + data['Base Metals (DBB)'].price.toFixed(2);
                        const baseMetalChange = document.getElementById('baseMetalChange');
                        baseMetalChange.textContent = (data['Base Metals (DBB)'].change >= 0 ? '+' : '') + data['Base Metals (DBB)'].change.toFixed(2) + '%';
                        baseMetalChange.className = 'indicator-signal ' + (data['Base Metals (DBB)'].change >= 0 ? 'bullish' : 'bearish');
                        if (data['Base Metals (DBB)'].volatility) {
                            const metalVolEl = document.getElementById('metalVol');
                            const vol = data['Base Metals (DBB)'].volatility;
                            const trend = data['Base Metals (DBB)'].vol_trend || 'STABLE';
                            metalVolEl.innerHTML = vol.toFixed(1) + '% <span style="color:' + getVolTrendColor(trend) + ';">' + getVolTrendIcon(trend) + '</span>';
                        }
                    }
                }
            } catch (error) { console.error('Commodities Error:', error); }
        }
        
        // Helper functions for volatility trend display
        function getVolTrendColor(trend) {
            if (trend === 'RISING') return '#ef4444';
            if (trend === 'FALLING') return '#3b82f6';
            return '#22c55e';
        }
        
        function getVolTrendIcon(trend) {
            if (trend === 'RISING') return '‚Üë';
            if (trend === 'FALLING') return '‚Üì';
            return '‚Üí';
        }
        
        // NEW: Fetch Volatility Index
        async function fetchVolatilityIndex() {
            try {
                const response = await fetch('/api/volatility');
                const result = await response.json();
                if (result.success) {
                    const data = result.data;
                    
                    // Composite Volatility
                    const compositeEl = document.getElementById('compositeVol');
                    compositeEl.textContent = data.composite_volatility.toFixed(1) + '%';
                    compositeEl.style.color = data.vol_signal === 'HIGH_VOL' ? '#ef4444' : 
                                              data.vol_signal === 'MODERATE_VOL' ? '#f59e0b' : '#22c55e';
                    
                    // Vol Signal
                    const volSignalEl = document.getElementById('volSignal');
                    volSignalEl.textContent = data.vol_signal.replace('_', ' ');
                    volSignalEl.className = 'indicator-signal ' + 
                        (data.vol_signal === 'HIGH_VOL' ? 'bullish' : 
                         data.vol_signal === 'LOW_VOL' ? 'bearish' : 'neutral');
                    
                    // MCX Outlook
                    const outlookEl = document.getElementById('mcxOutlook');
                    outlookEl.textContent = data.mcx_outlook;
                    outlookEl.style.color = data.mcx_outlook === 'BULLISH' ? '#22c55e' : 
                                            data.mcx_outlook === 'BEARISH' ? '#ef4444' : '#f59e0b';
                }
            } catch (error) { console.error('Volatility Error:', error); }
        }
        
        // NEW: Fetch MCX Volume Data
        async function fetchMCXVolume() {
            try {
                const response = await fetch('/api/mcx-volume');
                const result = await response.json();
                if (result.success) {
                    const data = result.data;
                    
                    // Current Volume
                    const volEl = document.getElementById('mcxVolume');
                    if (data.current_volume >= 1000000) {
                        volEl.textContent = (data.current_volume / 1000000).toFixed(2) + 'M';
                    } else if (data.current_volume >= 1000) {
                        volEl.textContent = (data.current_volume / 1000).toFixed(0) + 'K';
                    } else {
                        volEl.textContent = data.current_volume;
                    }
                    
                    // Volume Spike indicator
                    const spikeEl = document.getElementById('volumeSpike');
                    if (data.is_volume_spike) {
                        spikeEl.innerHTML = 'üî• SPIKE!';
                        spikeEl.className = 'indicator-signal bullish';
                    } else {
                        spikeEl.textContent = 'Normal';
                        spikeEl.className = 'indicator-signal neutral';
                    }
                    
                    // Volume Ratio
                    const ratioEl = document.getElementById('volumeRatioNew');
                    ratioEl.textContent = data.volume_ratio.toFixed(2) + 'x';
                    ratioEl.style.color = data.volume_ratio > 1.5 ? '#22c55e' : 
                                          data.volume_ratio < 0.7 ? '#ef4444' : '#f59e0b';
                    
                    // Volume Trend
                    const trendEl = document.getElementById('volumeTrend');
                    if (data.volume_ratio > 1.5) {
                        trendEl.textContent = 'HIGH ACTIVITY';
                        trendEl.className = 'indicator-signal bullish';
                    } else if (data.volume_ratio < 0.7) {
                        trendEl.textContent = 'LOW ACTIVITY';
                        trendEl.className = 'indicator-signal bearish';
                    } else {
                        trendEl.textContent = 'NORMAL';
                        trendEl.className = 'indicator-signal neutral';
                    }
                }
            } catch (error) { console.error('MCX Volume Error:', error); }
        }

        async function fetchAnalysis() {
            try {
                const response = await fetch('/api/analysis');
                const result = await response.json();
                if (result.success) {
                    const data = result.data;
                    document.getElementById('mcxPrice').textContent = '‚Çπ' + data.mcx_price.toFixed(2);
                    const mcxChangeEl = document.getElementById('mcxChange');
                    mcxChangeEl.textContent = (data.mcx_change >= 0 ? '+' : '') + data.mcx_change.toFixed(2) + '%';
                    mcxChangeEl.className = 'price-change ' + (data.mcx_change >= 0 ? 'positive' : 'negative');
                    
                    document.getElementById('metalPrice').textContent = '$' + data.metal_price.toFixed(2);
                    const metalChangeEl = document.getElementById('metalChange');
                    metalChangeEl.textContent = (data.metal_change >= 0 ? '+' : '') + data.metal_change.toFixed(2) + '%';
                    metalChangeEl.className = 'price-change ' + (data.metal_change >= 0 ? 'positive' : 'negative');
                    
                    document.getElementById('correlation').textContent = data.correlation.toFixed(3);
                    const corrStatus = document.getElementById('correlationStatus');
                    corrStatus.textContent = data.correlation > 0.3 ? 'Positive' : (data.correlation < -0.3 ? 'Negative' : 'Weak');
                    corrStatus.className = 'price-change ' + (data.correlation > 0.3 ? 'positive' : (data.correlation < -0.3 ? 'negative' : ''));
                    
                    const zScoreEl = document.getElementById('zScore');
                    zScoreEl.textContent = data.divergence_z.toFixed(2);
                    zScoreEl.style.color = data.divergence_z > 1.5 ? 'var(--accent-red)' : (data.divergence_z < -1.5 ? 'var(--accent-green)' : 'var(--accent-orange)');
                    
                    const signalBadge = document.getElementById('signalBadge');
                    signalBadge.textContent = data.signal;
                    signalBadge.className = 'signal-badge ' + data.signal_class;
                    
                    document.getElementById('lastUpdate').textContent = 'Updated: ' + new Date().toLocaleTimeString();
                    
                    document.getElementById('simStrike').value = Math.round(data.mcx_price / 10) * 10;
                    document.getElementById('posEntry').value = Math.round(data.mcx_price);
                    document.getElementById('posStop').value = Math.round(data.mcx_price * 0.95);
                }
            } catch (error) { console.error('Error:', error); }
        }

        async function fetchTechnical() {
            try {
                const response = await fetch('/api/technical');
                const result = await response.json();
                if (result.success) {
                    const data = result.data;
                    
                    document.getElementById('rsiValue').textContent = data.rsi.toFixed(1);
                    const rsiSignal = document.getElementById('rsiSignal');
                    rsiSignal.textContent = data.rsi_signal;
                    rsiSignal.className = 'indicator-signal ' + (data.rsi < 30 ? 'bullish' : (data.rsi > 70 ? 'bearish' : 'neutral'));
                    
                    document.getElementById('volatility').textContent = data.hist_volatility.toFixed(1) + '%';
                    document.getElementById('expectedMove').textContent = '30D Move: +/-‚Çπ' + data.expected_move_1std.toFixed(0);
                    
                    document.getElementById('macdValue').textContent = data.macd.toFixed(2);
                    const macdSignal = document.getElementById('macdSignal');
                    macdSignal.textContent = data.macd_trend;
                    macdSignal.className = 'indicator-signal ' + (data.macd_trend === 'BULLISH' ? 'bullish' : 'bearish');
                    
                    document.getElementById('bbValue').textContent = data.bb_position;
                    const bbSignal = document.getElementById('bbSignal');
                    bbSignal.textContent = data.bb_position === 'LOWER' ? 'Oversold' : (data.bb_position === 'UPPER' ? 'Overbought' : 'Normal');
                    bbSignal.className = 'indicator-signal ' + (data.bb_position === 'LOWER' ? 'bullish' : (data.bb_position === 'UPPER' ? 'bearish' : 'neutral'));
                    
                    document.getElementById('smaValue').textContent = data.trend_sma;
                    const smaSignal = document.getElementById('smaSignal');
                    smaSignal.textContent = 'vs SMA50';
                    smaSignal.className = 'indicator-signal ' + (data.trend_sma === 'BULLISH' ? 'bullish' : 'bearish');
                    
                    document.getElementById('volumeValue').textContent = data.volume_ratio.toFixed(2) + 'x';
                    const volumeSignal = document.getElementById('volumeSignal');
                    volumeSignal.textContent = data.volume_signal;
                    volumeSignal.className = 'indicator-signal ' + (data.volume_signal === 'HIGH' ? 'bullish' : (data.volume_signal === 'LOW' ? 'bearish' : 'neutral'));
                    
                    document.getElementById('srLevels').innerHTML = 
                        '<div class="sr-level sr-resistance"><span>R2</span><span>‚Çπ' + data.r2.toFixed(0) + '</span></div>' +
                        '<div class="sr-level sr-resistance"><span>R1</span><span>‚Çπ' + data.r1.toFixed(0) + '</span></div>' +
                        '<div class="sr-level sr-pivot"><span>Pivot</span><span>‚Çπ' + data.pivot.toFixed(0) + '</span></div>' +
                        '<div class="sr-level sr-support"><span>S1</span><span>‚Çπ' + data.s1.toFixed(0) + '</span></div>' +
                        '<div class="sr-level sr-support"><span>S2</span><span>‚Çπ' + data.s2.toFixed(0) + '</span></div>' +
                        '<hr style="border-color: rgba(255,255,255,0.1); margin: 0.5rem 0;">' +
                        '<div class="sr-level"><span>SMA 20</span><span>‚Çπ' + data.sma20.toFixed(0) + '</span></div>' +
                        '<div class="sr-level"><span>SMA 50</span><span>‚Çπ' + data.sma50.toFixed(0) + '</span></div>' +
                        '<div class="sr-level"><span>ATR (14)</span><span>‚Çπ' + data.atr.toFixed(0) + '</span></div>';
                }
            } catch (error) { console.error('Error:', error); }
        }

        async function fetchPreMarket() {
            try {
                const response = await fetch('/api/pre-market');
                const result = await response.json();
                if (result.success && result.data) {
                    const data = result.data;
                    document.getElementById('prevClose').textContent = '‚Çπ' + data.prev_close.toFixed(0);
                    document.getElementById('prevHigh').textContent = '‚Çπ' + data.prev_high.toFixed(0);
                    document.getElementById('prevLow').textContent = '‚Çπ' + data.prev_low.toFixed(0);
                    
                    const weeklyEl = document.getElementById('weeklyChange');
                    weeklyEl.textContent = (data.weekly_change >= 0 ? '+' : '') + data.weekly_change.toFixed(2) + '%';
                    weeklyEl.style.color = data.weekly_change >= 0 ? 'var(--accent-green)' : 'var(--accent-red)';
                    
                    const monthlyEl = document.getElementById('monthlyChange');
                    monthlyEl.textContent = (data.monthly_change >= 0 ? '+' : '') + data.monthly_change.toFixed(2) + '%';
                    monthlyEl.style.color = data.monthly_change >= 0 ? 'var(--accent-green)' : 'var(--accent-red)';
                    
                    const metalON = document.getElementById('metalOvernight');
                    metalON.textContent = (data.metal_overnight_change >= 0 ? '+' : '') + data.metal_overnight_change.toFixed(2) + '%';
                    metalON.style.color = data.metal_overnight_change >= 0 ? 'var(--accent-green)' : 'var(--accent-red)';
                    
                    document.getElementById('high52w').textContent = '‚Çπ' + data.high_52w.toFixed(0);
                    document.getElementById('from52wHigh').textContent = data.from_52w_high.toFixed(1) + '%';
                    document.getElementById('from52wLow').textContent = '+' + data.from_52w_low.toFixed(1) + '%';
                    
                    const divBadge = document.getElementById('divergenceBadge');
                    if (data.divergence_building) {
                        divBadge.textContent = 'DIVERGENCE';
                        divBadge.style.background = 'rgba(255,165,0,0.2)';
                        divBadge.style.color = 'var(--accent-orange)';
                    } else {
                        divBadge.textContent = 'IN SYNC';
                        divBadge.style.background = 'rgba(0,255,136,0.2)';
                        divBadge.style.color = 'var(--accent-green)';
                    }
                } else {
                    console.error('Pre-market API error:', result.error);
                }
            } catch (error) { console.error('Pre-market fetch error:', error); }
        }

        async function fetchStrategy() {
            try {
                const response = await fetch('/api/strategy');
                const result = await response.json();
                if (result.success) {
                    const data = result.data;
                    const signalClass = data.signal.includes('BULL') ? 'bullish' : (data.signal.includes('BEAR') ? 'bearish' : 'neutral');
                    
                    // Build volatility context display
                    let volContextHtml = '';
                    if (data.vol_context) {
                        const vc = data.vol_context;
                        volContextHtml = '<div style="margin-top: 0.75rem; padding: 0.5rem; background: rgba(168,85,247,0.1); border: 1px solid var(--accent-purple); border-radius: 6px; font-size: 0.7rem;">' +
                            '<strong style="color: var(--accent-purple);">‚ö° Volatility Context:</strong><br>' +
                            '<span style="color: var(--text-secondary);">Composite Vol: </span><span style="color: ' + (vc.composite_volatility > 30 ? '#ef4444' : vc.composite_volatility > 20 ? '#f59e0b' : '#22c55e') + ';">' + vc.composite_volatility.toFixed(1) + '%</span> | ' +
                            '<span style="color: var(--text-secondary);">Volume: </span><span style="color: ' + (vc.volume_ratio > 1.5 ? '#22c55e' : '#f59e0b') + ';">' + vc.volume_ratio.toFixed(1) + 'x avg</span>' +
                            (vc.is_volume_spike ? ' <span style="color: #ef4444;">üî• SPIKE!</span>' : '') +
                        '</div>';
                    }
                    
                    document.getElementById('strategyContent').innerHTML = 
                        '<div class="strategy-name">' + data.name + '</div>' +
                        '<div style="margin-bottom: 0.75rem;">' +
                            '<span class="indicator-signal ' + signalClass + '">' + data.signal + '</span>' +
                            '<span class="ms-2" style="font-size: 0.8rem; color: var(--text-secondary);">Confidence: ' + data.confidence + '</span>' +
                            (data.volatility_driven ? '<span class="ms-2" style="font-size: 0.65rem; background: rgba(168,85,247,0.3); padding: 2px 6px; border-radius: 4px; color: var(--accent-purple);">‚ö° VOL-DRIVEN</span>' : '') +
                        '</div>' +
                        '<div class="metric-row"><span class="metric-label">Strike(s)</span><span class="metric-value">' + data.strike + '</span></div>' +
                        '<div class="metric-row"><span class="metric-label">Action</span><span class="metric-value" style="font-size: 0.8rem;">' + data.action + '</span></div>' +
                        '<div style="margin-top: 0.75rem; padding: 0.5rem; background: var(--bg-dark); border-radius: 6px; font-size: 0.75rem; color: #ffffff;">' +
                            '<strong style="color: var(--accent-blue);">Rationale:</strong> ' + data.rationale +
                        '</div>' +
                        volContextHtml +
                        '<div style="margin-top: 0.5rem; color: var(--accent-orange); font-size: 0.75rem;">' +
                            '<strong>Risk:</strong> ' + data.risk +
                        '</div>';
                }
            } catch (error) { console.error('Error:', error); }
        }

        async function fetchOptionChain() {
            const days = document.getElementById('expirySelect').value;
            try {
                const response = await fetch('/api/option-chain?days=' + days);
                const result = await response.json();
                if (result.success) {
                    const data = result.data;
                    let html = '<table class="option-chain-table"><thead><tr>' +
                        '<th colspan="5" style="background: rgba(0,255,136,0.2); color: var(--accent-green);">CALLS</th>' +
                        '<th style="background: var(--accent-blue); color: var(--bg-dark);">STRIKE</th>' +
                        '<th colspan="5" style="background: rgba(255,71,87,0.2); color: var(--accent-red);">PUTS</th>' +
                    '</tr><tr>' +
                        '<th>Vega</th><th>Theta</th><th>Gamma</th><th>Delta</th><th>Price</th>' +
                        '<th>‚Çπ</th>' +
                        '<th>Price</th><th>Delta</th><th>Gamma</th><th>Theta</th><th>Vega</th>' +
                    '</tr></thead><tbody>';
                    
                    data.forEach(function(row) {
                        const atmClass = row.is_atm ? 'atm-row' : '';
                        html += '<tr class="' + atmClass + '">' +
                            '<td class="call-side">' + row.call_vega + '</td>' +
                            '<td class="call-side">' + row.call_theta + '</td>' +
                            '<td class="call-side">' + row.call_gamma + '</td>' +
                            '<td class="call-side">' + row.call_delta + '</td>' +
                            '<td class="call-side" style="font-weight:bold;">‚Çπ' + row.call_price + '</td>' +
                            '<td class="strike-col">' + row.strike + '</td>' +
                            '<td class="put-side" style="font-weight:bold;">‚Çπ' + row.put_price + '</td>' +
                            '<td class="put-side">' + row.put_delta + '</td>' +
                            '<td class="put-side">' + row.put_gamma + '</td>' +
                            '<td class="put-side">' + row.put_theta + '</td>' +
                            '<td class="put-side">' + row.put_vega + '</td>' +
                        '</tr>';
                    });
                    
                    html += '</tbody></table>';
                    html += '<div class="mt-2 text-center" style="font-size:0.75rem;color:var(--text-secondary);">Spot: ‚Çπ' + result.spot.toFixed(2) + ' | Expiry: ' + days + ' days | Lot: 625</div>';
                    document.getElementById('optionChainContainer').innerHTML = html;
                } else {
                    document.getElementById('optionChainContainer').innerHTML = '<div class="text-center" style="color:var(--accent-red);padding:1rem;">Error: ' + (result.error || 'Unknown error') + '</div>';
                }
            } catch (error) {
                console.error('Option Chain Error:', error);
                document.getElementById('optionChainContainer').innerHTML = '<div class="text-center" style="color:var(--accent-red);padding:1rem;">Failed to load: ' + error.message + '</div>';
            }
        }

        async function fetchCharts() {
            try {
                const priceResponse = await fetch('/api/charts/price');
                const priceResult = await priceResponse.json();
                if (priceResult.success) {
                    document.getElementById('priceChart').innerHTML = '<img src="data:image/png;base64,' + priceResult.chart + '" alt="Price Chart">';
                }
            } catch (error) { console.error('Error:', error); }
            
            try {
                const corrResponse = await fetch('/api/charts/correlation');
                const corrResult = await corrResponse.json();
                if (corrResult.success) {
                    document.getElementById('correlationChart').innerHTML = '<img src="data:image/png;base64,' + corrResult.chart + '" alt="Correlation Chart">';
                }
            } catch (error) { console.error('Error:', error); }
        }

        async function simulatePnL() {
            const data = {
                option_type: document.getElementById('simType').value,
                strike: parseFloat(document.getElementById('simStrike').value),
                premium: parseFloat(document.getElementById('simPremium').value),
                lots: parseInt(document.getElementById('simLots').value)
            };
            
            try {
                const response = await fetch('/api/pnl-simulator', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(data)
                });
                const result = await response.json();
                if (result.success) {
                    document.getElementById('pnlResult').style.display = 'block';
                    document.getElementById('breakeven').textContent = '‚Çπ' + result.breakeven.toFixed(0);
                    document.getElementById('maxLoss').textContent = '-‚Çπ' + result.max_loss.toLocaleString();
                    document.getElementById('totalShares').textContent = result.total_shares.toLocaleString();
                    
                    let tableHtml = '<table style="width:100%;font-size:0.75rem;margin-top:0.5rem;">';
                    result.data.filter(function(_, i) { return i % 2 === 0; }).forEach(function(item) {
                        const pnlClass = item.pnl_per_lot >= 0 ? 'pnl-positive' : 'pnl-negative';
                        const prefix = item.pnl_per_lot >= 0 ? '+' : '';
                        tableHtml += '<tr>' +
                            '<td>‚Çπ' + item.spot.toFixed(0) + '</td>' +
                            '<td class="' + pnlClass + '" style="text-align:right;">' + prefix + '‚Çπ' + item.pnl_per_lot.toLocaleString() + '</td>' +
                        '</tr>';
                    });
                    tableHtml += '</table>';
                    document.getElementById('pnlTable').innerHTML = tableHtml;
                }
            } catch (error) { console.error('Error:', error); }
        }

        async function calculatePosition() {
            const data = {
                capital: parseFloat(document.getElementById('posCapital').value),
                risk_percent: parseFloat(document.getElementById('posRisk').value),
                entry_price: parseFloat(document.getElementById('posEntry').value),
                stop_loss: parseFloat(document.getElementById('posStop').value)
            };
            
            try {
                const response = await fetch('/api/position-size', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(data)
                });
                const result = await response.json();
                if (result.success && result.data) {
                    document.getElementById('positionResult').style.display = 'block';
                    document.getElementById('riskAmount').textContent = '‚Çπ' + result.data.risk_amount.toLocaleString();
                    document.getElementById('recLots').textContent = result.data.lots + ' lots';
                    document.getElementById('recShares').textContent = result.data.actual_shares.toLocaleString();
                    document.getElementById('capRequired').textContent = '‚Çπ' + result.data.capital_required.toLocaleString();
                }
            } catch (error) { console.error('Error:', error); }
        }

        async function refreshAll() {
            await Promise.all([
                fetchAnalysis(),
                fetchCommodities(),
                fetchVolatilityIndex(),
                fetchMCXVolume(),
                fetchTechnical(),
                fetchPreMarket(),
                fetchStrategy(),
                fetchOptionChain(),
                fetchCharts()
            ]);
        }

        document.getElementById('expirySelect').addEventListener('change', fetchOptionChain);
        
        refreshAll();
        setInterval(refreshAll, 300000);
    </script>
</body>
</html>
