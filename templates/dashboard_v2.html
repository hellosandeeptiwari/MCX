<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MCX Trading Dashboard v2.0</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --bg-dark: #0f0f1a;
            --bg-card: #1a1a2e;
            --accent-blue: #00d4ff;
            --accent-green: #00ff88;
            --accent-orange: #ffa500;
            --accent-red: #ff4757;
            --accent-purple: #a855f7;
            --text-primary: #ffffff;
            --text-secondary: #8892b0;
        }
        body {
            background: var(--bg-dark);
            color: var(--text-primary);
            font-family: 'Segoe UI', sans-serif;
            min-height: 100vh;
        }
        .navbar {
            background: var(--bg-card) !important;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            padding: 1rem 2rem;
        }
        .navbar-brand {
            font-size: 1.4rem;
            font-weight: 700;
            color: var(--accent-blue) !important;
        }
        .main-container { padding: 1.5rem; max-width: 1600px; margin: 0 auto; }
        .card {
            background: var(--bg-card);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 12px;
            margin-bottom: 1rem;
        }
        .card-header {
            background: rgba(255,255,255,0.05);
            border-bottom: 1px solid rgba(255,255,255,0.1);
            padding: 0.75rem 1rem;
            font-weight: 600;
            color: var(--text-primary);
        }
        .card-body { padding: 1rem; }
        
        .insight-banner {
            background: linear-gradient(135deg, rgba(239,68,68,0.1), rgba(168,85,247,0.1));
            border: 1px solid var(--accent-orange);
            border-radius: 12px;
            padding: 1rem 1.5rem;
            margin-bottom: 1.5rem;
        }
        .insight-title {
            color: var(--accent-orange);
            font-weight: 700;
            font-size: 1.1rem;
            margin-bottom: 0.5rem;
        }
        
        .metric-card {
            text-align: center;
            padding: 1rem;
        }
        .metric-label {
            font-size: 0.75rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            margin-bottom: 0.25rem;
        }
        .metric-value {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--text-primary);
        }
        .metric-change {
            font-size: 0.9rem;
            font-weight: 600;
        }
        .metric-change.positive { color: var(--accent-green); }
        .metric-change.negative { color: var(--accent-red); }
        
        .signal-badge {
            display: inline-block;
            padding: 0.4rem 1rem;
            border-radius: 20px;
            font-weight: 700;
            font-size: 0.9rem;
        }
        .signal-badge.bullish { background: rgba(0,255,136,0.2); color: var(--accent-green); }
        .signal-badge.bearish { background: rgba(255,71,87,0.2); color: var(--accent-red); }
        .signal-badge.neutral { background: rgba(255,165,0,0.2); color: var(--accent-orange); }
        
        .driver-card {
            border-radius: 10px;
            padding: 1rem;
            height: 100%;
        }
        .driver-card.primary {
            background: linear-gradient(135deg, rgba(0,212,255,0.15), rgba(0,212,255,0.05));
            border: 2px solid var(--accent-blue);
        }
        .driver-card.secondary {
            background: rgba(168,85,247,0.1);
            border: 1px solid var(--accent-purple);
        }
        .driver-card.technical {
            background: rgba(255,165,0,0.1);
            border: 1px solid var(--accent-orange);
        }
        
        .driver-label {
            font-size: 0.7rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        .driver-value {
            font-size: 1.5rem;
            font-weight: 700;
        }
        .driver-note {
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-top: 0.5rem;
        }
        
        .weight-bar {
            height: 8px;
            background: rgba(255,255,255,0.1);
            border-radius: 4px;
            overflow: hidden;
            margin-top: 0.5rem;
        }
        .weight-fill {
            height: 100%;
            border-radius: 4px;
        }
        
        .reason-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        .reason-list li {
            padding: 0.5rem 0;
            border-bottom: 1px solid rgba(255,255,255,0.05);
            font-size: 0.85rem;
        }
        .reason-list li:last-child { border-bottom: none; }
        
        .option-table {
            width: 100%;
            font-size: 0.8rem;
        }
        .option-table th {
            background: rgba(255,255,255,0.05);
            padding: 0.5rem;
            text-align: center;
            font-weight: 600;
            color: var(--text-secondary);
        }
        .option-table td {
            padding: 0.4rem;
            text-align: center;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }
        .option-table .atm-row {
            background: rgba(0,212,255,0.1);
            font-weight: 600;
        }
        .option-table .strike-col {
            background: rgba(255,255,255,0.05);
            font-weight: 700;
            color: var(--accent-blue);
        }
        .option-table .call-side { color: var(--accent-green); }
        .option-table .put-side { color: var(--accent-red); }
        
        .disclaimer {
            background: rgba(255,71,87,0.1);
            border: 1px solid var(--accent-red);
            border-radius: 8px;
            padding: 1rem;
            font-size: 0.8rem;
            color: var(--text-secondary);
        }
        
        .btn-refresh {
            background: var(--accent-blue);
            border: none;
            color: var(--bg-dark);
            padding: 0.5rem 1rem;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
        }
        .btn-refresh:hover { opacity: 0.9; }
        
        .loading { opacity: 0.5; }
    </style>
</head>
<body>
    <nav class="navbar">
        <div class="container-fluid">
            <span class="navbar-brand">
                <i class="fas fa-chart-line me-2"></i>MCX Trading Dashboard v2.0
                <span style="font-size: 0.7rem; color: var(--accent-purple); margin-left: 10px;">DATA-DRIVEN</span>
            </span>
            <div>
                <span class="text-secondary me-3" style="font-size: 0.8rem;" id="lastUpdate">--</span>
                <button class="btn-refresh" onclick="refreshData()">
                    <i class="fas fa-sync-alt me-1"></i>Refresh
                </button>
            </div>
        </div>
    </nav>

    <div class="main-container">
        <!-- Key Insight Banner -->
        <div class="insight-banner">
            <div class="insight-title"><i class="fas fa-flask me-2"></i>Data Science Findings</div>
            <div class="row">
                <div class="col-md-8">
                    <p style="margin-bottom: 0.5rem; color: var(--text-primary);">
                        Based on 2 years of data analysis, here's what ACTUALLY drives MCX stock:
                    </p>
                    <ul style="margin: 0; padding-left: 1.2rem; color: var(--text-secondary); font-size: 0.85rem;">
                        <li><strong style="color: var(--accent-blue);">NIFTY (52% correlation)</strong> - MCX moves with the market, not commodities</li>
                        <li><strong style="color: var(--accent-purple);">Lagged Effect</strong> - Yesterday's Gold/Silver moves slightly predict today (+14-16%)</li>
                        <li><strong style="color: var(--accent-orange);">71% unexplained</strong> - Company-specific factors (earnings, news, SEBI rules)</li>
                    </ul>
                </div>
                <div class="col-md-4 text-center" style="border-left: 1px solid rgba(255,255,255,0.1);">
                    <div style="font-size: 0.75rem; color: var(--text-secondary);">Same-Day Commodity Correlation</div>
                    <div style="font-size: 2rem; font-weight: 700; color: var(--accent-red);">WEAK</div>
                    <div style="font-size: 0.7rem; color: var(--text-secondary);">Gold: 0.04 | Silver: 0.08 | Oil: -0.01</div>
                </div>
            </div>
        </div>

        <!-- Main Metrics Row -->
        <div class="row mb-3">
            <div class="col-lg-3 col-md-6">
                <div class="card h-100">
                    <div class="metric-card">
                        <div class="metric-label">MCX Ltd Price</div>
                        <div class="metric-value" id="mcxPrice">--</div>
                        <div class="metric-change" id="mcxChange">--</div>
                    </div>
                </div>
            </div>
            <div class="col-lg-3 col-md-6">
                <div class="card h-100">
                    <div class="metric-card">
                        <div class="metric-label">Trading Signal</div>
                        <div id="tradingSignal" class="signal-badge neutral mt-2">--</div>
                        <div class="mt-2" style="font-size: 0.8rem; color: var(--text-secondary);">
                            Confidence: <span id="signalConfidence">--</span>%
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-lg-3 col-md-6">
                <div class="card h-100">
                    <div class="metric-card">
                        <div class="metric-label">Suggested Strategy</div>
                        <div class="metric-value" style="font-size: 1.2rem;" id="strategy">--</div>
                    </div>
                </div>
            </div>
            <div class="col-lg-3 col-md-6">
                <div class="card h-100">
                    <div class="metric-card">
                        <div class="metric-label">Expected Range (ATR)</div>
                        <div id="expectedRange" style="font-size: 1.1rem; color: var(--text-primary);">--</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Signal Drivers -->
        <div class="row mb-3">
            <div class="col-lg-4">
                <div class="driver-card primary">
                    <div class="driver-label">ðŸŽ¯ Primary Driver (52% weight)</div>
                    <div class="driver-value" style="color: var(--accent-blue);">NIFTY</div>
                    <div class="row mt-2">
                        <div class="col-6">
                            <div style="font-size: 0.7rem; color: var(--text-secondary);">Today's Move</div>
                            <div id="niftyChange" style="font-size: 1.2rem; font-weight: 600;">--</div>
                        </div>
                        <div class="col-6">
                            <div style="font-size: 0.7rem; color: var(--text-secondary);">Trend</div>
                            <div id="niftyTrend" style="font-size: 1.2rem; font-weight: 600;">--</div>
                        </div>
                    </div>
                    <div class="weight-bar">
                        <div class="weight-fill" style="width: 52%; background: var(--accent-blue);"></div>
                    </div>
                    <div class="driver-note">MCX is a stock first - market direction dominates</div>
                </div>
            </div>
            <div class="col-lg-4">
                <div class="driver-card secondary">
                    <div class="driver-label">ðŸ“ˆ Lagged Signal (15% weight)</div>
                    <div class="driver-value" style="color: var(--accent-purple);" id="laggedDirection">--</div>
                    <div id="laggedDetails" style="font-size: 0.8rem; margin-top: 0.5rem;">
                        <!-- Filled by JS -->
                    </div>
                    <div class="weight-bar">
                        <div class="weight-fill" style="width: 15%; background: var(--accent-purple);"></div>
                    </div>
                    <div class="driver-note">Yesterday's commodity moves predict today's MCX</div>
                </div>
            </div>
            <div class="col-lg-4">
                <div class="driver-card technical">
                    <div class="driver-label">ðŸ“Š Technicals (33% weight)</div>
                    <div class="row mt-2">
                        <div class="col-6">
                            <div style="font-size: 0.7rem; color: var(--text-secondary);">RSI (14)</div>
                            <div id="rsiValue" style="font-size: 1.2rem; font-weight: 600;">--</div>
                            <div id="rsiSignal" style="font-size: 0.7rem;">--</div>
                        </div>
                        <div class="col-6">
                            <div style="font-size: 0.7rem; color: var(--text-secondary);">MACD</div>
                            <div id="macdSignal" style="font-size: 1.2rem; font-weight: 600;">--</div>
                        </div>
                    </div>
                    <div class="weight-bar">
                        <div class="weight-fill" style="width: 33%; background: var(--accent-orange);"></div>
                    </div>
                    <div class="driver-note">Standard technical indicators on MCX stock</div>
                </div>
            </div>
        </div>

        <!-- Signal Reasons -->
        <div class="row mb-3">
            <div class="col-lg-6">
                <div class="card h-100">
                    <div class="card-header"><i class="fas fa-list-check me-2"></i>Signal Breakdown</div>
                    <div class="card-body">
                        <ul class="reason-list" id="reasonsList">
                            <li>Loading...</li>
                        </ul>
                    </div>
                </div>
            </div>
            <div class="col-lg-6">
                <div class="card h-100">
                    <div class="card-header"><i class="fas fa-ruler-combined me-2"></i>Support & Resistance</div>
                    <div class="card-body">
                        <div class="row text-center">
                            <div class="col-4">
                                <div style="font-size: 0.75rem; color: var(--text-secondary);">Resistance</div>
                                <div id="resistance" style="font-size: 1.3rem; font-weight: 700; color: var(--accent-red);">--</div>
                            </div>
                            <div class="col-4">
                                <div style="font-size: 0.75rem; color: var(--text-secondary);">Current</div>
                                <div id="currentPrice" style="font-size: 1.3rem; font-weight: 700; color: var(--accent-blue);">--</div>
                            </div>
                            <div class="col-4">
                                <div style="font-size: 0.75rem; color: var(--text-secondary);">Support</div>
                                <div id="support" style="font-size: 1.3rem; font-weight: 700; color: var(--accent-green);">--</div>
                            </div>
                        </div>
                        <div class="mt-3">
                            <div style="font-size: 0.75rem; color: var(--text-secondary);">Bollinger Bands</div>
                            <div class="row text-center mt-1">
                                <div class="col-4">
                                    <span style="font-size: 0.8rem; color: var(--accent-red);" id="bbUpper">--</span>
                                </div>
                                <div class="col-4">
                                    <span style="font-size: 0.8rem;" id="bbMiddle">--</span>
                                </div>
                                <div class="col-4">
                                    <span style="font-size: 0.8rem; color: var(--accent-green);" id="bbLower">--</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Option Chain -->
        <div class="card mb-3">
            <div class="card-header">
                <i class="fas fa-th me-2"></i>Option Chain (Theoretical - Black-Scholes)
                <select id="expirySelect" class="form-select form-select-sm" style="width: auto; display: inline-block; margin-left: 1rem; background: var(--bg-dark); color: var(--text-primary); border-color: rgba(255,255,255,0.2);">
                    <option value="7">Weekly (7 days)</option>
                    <option value="30" selected>Monthly (30 days)</option>
                    <option value="60">2 Months</option>
                </select>
            </div>
            <div class="card-body" style="overflow-x: auto;">
                <table class="option-table" id="optionChain">
                    <thead>
                        <tr>
                            <th colspan="4" style="color: var(--accent-green);">CALLS</th>
                            <th>STRIKE</th>
                            <th colspan="4" style="color: var(--accent-red);">PUTS</th>
                        </tr>
                        <tr>
                            <th>Delta</th><th>Gamma</th><th>Theta</th><th>Price</th>
                            <th>â‚¹</th>
                            <th>Price</th><th>Theta</th><th>Gamma</th><th>Delta</th>
                        </tr>
                    </thead>
                    <tbody id="optionChainBody">
                        <tr><td colspan="9">Loading...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Position Sizer -->
        <div class="row mb-3">
            <div class="col-lg-6">
                <div class="card h-100">
                    <div class="card-header"><i class="fas fa-calculator me-2"></i>Position Size Calculator</div>
                    <div class="card-body">
                        <div class="row g-2">
                            <div class="col-6">
                                <label style="font-size: 0.75rem; color: var(--text-secondary);">Capital (â‚¹)</label>
                                <input type="number" id="capital" value="500000" class="form-control form-control-sm" style="background: var(--bg-dark); color: var(--text-primary); border-color: rgba(255,255,255,0.2);">
                            </div>
                            <div class="col-6">
                                <label style="font-size: 0.75rem; color: var(--text-secondary);">Risk %</label>
                                <input type="number" id="riskPct" value="2" class="form-control form-control-sm" style="background: var(--bg-dark); color: var(--text-primary); border-color: rgba(255,255,255,0.2);">
                            </div>
                            <div class="col-6">
                                <label style="font-size: 0.75rem; color: var(--text-secondary);">Entry Price</label>
                                <input type="number" id="entryPrice" value="2300" class="form-control form-control-sm" style="background: var(--bg-dark); color: var(--text-primary); border-color: rgba(255,255,255,0.2);">
                            </div>
                            <div class="col-6">
                                <label style="font-size: 0.75rem; color: var(--text-secondary);">Stop Loss</label>
                                <input type="number" id="stopLoss" value="2200" class="form-control form-control-sm" style="background: var(--bg-dark); color: var(--text-primary); border-color: rgba(255,255,255,0.2);">
                            </div>
                        </div>
                        <button class="btn btn-sm btn-primary mt-2 w-100" onclick="calculatePosition()">Calculate</button>
                        <div id="positionResult" class="mt-2" style="font-size: 0.85rem;"></div>
                    </div>
                </div>
            </div>
            <div class="col-lg-6">
                <div class="disclaimer">
                    <strong><i class="fas fa-exclamation-triangle me-2"></i>Important Disclaimer</strong>
                    <ul style="margin: 0.5rem 0 0 0; padding-left: 1.2rem;">
                        <li>Only 29% of MCX movement is explained by these factors</li>
                        <li>71% depends on company news, earnings, SEBI rules</li>
                        <li>Commodity prices do NOT directly drive MCX stock</li>
                        <li>This is for educational purposes only</li>
                        <li>Always do your own research before trading</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <script>
        async function refreshData() {
            try {
                const response = await fetch('/api/overview');
                const result = await response.json();
                
                if (result.success) {
                    const data = result.data;
                    
                    // MCX Price
                    if (data.mcx) {
                        document.getElementById('mcxPrice').textContent = 'â‚¹' + data.mcx.price.toFixed(2);
                        const changeEl = document.getElementById('mcxChange');
                        changeEl.textContent = (data.mcx.change_pct >= 0 ? '+' : '') + data.mcx.change_pct.toFixed(2) + '%';
                        changeEl.className = 'metric-change ' + (data.mcx.change_pct >= 0 ? 'positive' : 'negative');
                        
                        document.getElementById('currentPrice').textContent = 'â‚¹' + data.mcx.price.toFixed(0);
                        document.getElementById('support').textContent = 'â‚¹' + data.mcx.support.toFixed(0);
                        document.getElementById('resistance').textContent = 'â‚¹' + data.mcx.resistance.toFixed(0);
                        
                        document.getElementById('bbUpper').textContent = 'â‚¹' + data.mcx.bb_upper.toFixed(0);
                        document.getElementById('bbMiddle').textContent = 'â‚¹' + data.mcx.bb_middle.toFixed(0);
                        document.getElementById('bbLower').textContent = 'â‚¹' + data.mcx.bb_lower.toFixed(0);
                        
                        document.getElementById('expectedRange').innerHTML = 
                            'â‚¹' + data.mcx.expected_range.low.toFixed(0) + ' - â‚¹' + data.mcx.expected_range.high.toFixed(0);
                        
                        document.getElementById('rsiValue').textContent = data.mcx.rsi.toFixed(0);
                        document.getElementById('rsiSignal').textContent = data.mcx.rsi_signal;
                        document.getElementById('rsiSignal').style.color = 
                            data.mcx.rsi_signal === 'OVERSOLD' ? 'var(--accent-green)' : 
                            (data.mcx.rsi_signal === 'OVERBOUGHT' ? 'var(--accent-red)' : 'var(--accent-orange)');
                        
                        document.getElementById('macdSignal').textContent = data.mcx.macd_signal;
                        document.getElementById('macdSignal').style.color = 
                            data.mcx.macd_signal === 'BULLISH' ? 'var(--accent-green)' : 'var(--accent-red)';
                        
                        document.getElementById('entryPrice').value = Math.round(data.mcx.price);
                        document.getElementById('stopLoss').value = Math.round(data.mcx.price * 0.95);
                    }
                    
                    // Nifty
                    if (data.nifty) {
                        const niftyChangeEl = document.getElementById('niftyChange');
                        niftyChangeEl.textContent = (data.nifty.nifty_today_change >= 0 ? '+' : '') + data.nifty.nifty_today_change.toFixed(2) + '%';
                        niftyChangeEl.style.color = data.nifty.nifty_today_change >= 0 ? 'var(--accent-green)' : 'var(--accent-red)';
                        
                        document.getElementById('niftyTrend').textContent = data.nifty.nifty_trend;
                        document.getElementById('niftyTrend').style.color = 
                            data.nifty.nifty_trend === 'BULLISH' ? 'var(--accent-green)' : 'var(--accent-red)';
                    }
                    
                    // Lagged Signal
                    if (data.lagged_signal && data.lagged_signal.direction) {
                        document.getElementById('laggedDirection').textContent = data.lagged_signal.direction;
                        document.getElementById('laggedDirection').style.color = 
                            data.lagged_signal.direction === 'BULLISH' ? 'var(--accent-green)' : 
                            (data.lagged_signal.direction === 'BEARISH' ? 'var(--accent-red)' : 'var(--accent-orange)');
                        
                        let detailsHtml = '';
                        if (data.lagged_signal.signals) {
                            for (const [comm, info] of Object.entries(data.lagged_signal.signals)) {
                                const color = info.yesterday_return >= 0 ? 'var(--accent-green)' : 'var(--accent-red)';
                                detailsHtml += `<div>${comm}: <span style="color: ${color}">${info.yesterday_return >= 0 ? '+' : ''}${info.yesterday_return.toFixed(2)}%</span></div>`;
                            }
                        }
                        document.getElementById('laggedDetails').innerHTML = detailsHtml;
                    }
                    
                    // Trading Signal
                    if (data.trading_signal) {
                        const signalEl = document.getElementById('tradingSignal');
                        signalEl.textContent = data.trading_signal.signal;
                        signalEl.className = 'signal-badge ' + data.trading_signal.signal.toLowerCase();
                        
                        document.getElementById('signalConfidence').textContent = data.trading_signal.confidence.toFixed(0);
                        document.getElementById('strategy').textContent = data.trading_signal.strategy;
                        
                        // Reasons
                        const reasonsList = document.getElementById('reasonsList');
                        if (data.trading_signal.reasons && data.trading_signal.reasons.length > 0) {
                            reasonsList.innerHTML = data.trading_signal.reasons.map(r => `<li><i class="fas fa-check-circle me-2" style="color: var(--accent-blue);"></i>${r}</li>`).join('');
                        }
                    }
                    
                    document.getElementById('lastUpdate').textContent = 'Updated: ' + new Date().toLocaleTimeString();
                }
            } catch (error) {
                console.error('Error:', error);
            }
            
            // Fetch option chain
            fetchOptionChain();
        }
        
        async function fetchOptionChain() {
            const days = document.getElementById('expirySelect').value;
            try {
                const response = await fetch('/api/option-chain?days=' + days);
                const result = await response.json();
                
                if (result.success) {
                    let html = '';
                    result.data.forEach(row => {
                        const atmClass = row.is_atm ? 'atm-row' : '';
                        html += `<tr class="${atmClass}">
                            <td class="call-side">${row.call_delta}</td>
                            <td class="call-side">${row.gamma}</td>
                            <td class="call-side">${row.call_theta}</td>
                            <td class="call-side" style="font-weight:bold;">â‚¹${row.call_price}</td>
                            <td class="strike-col">${row.strike}</td>
                            <td class="put-side" style="font-weight:bold;">â‚¹${row.put_price}</td>
                            <td class="put-side">${row.put_theta}</td>
                            <td class="put-side">${row.gamma}</td>
                            <td class="put-side">${row.put_delta}</td>
                        </tr>`;
                    });
                    document.getElementById('optionChainBody').innerHTML = html;
                }
            } catch (error) {
                console.error('Option chain error:', error);
            }
        }
        
        async function calculatePosition() {
            const data = {
                capital: parseFloat(document.getElementById('capital').value),
                risk_percent: parseFloat(document.getElementById('riskPct').value),
                entry_price: parseFloat(document.getElementById('entryPrice').value),
                stop_loss: parseFloat(document.getElementById('stopLoss').value)
            };
            
            try {
                const response = await fetch('/api/position-size', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(data)
                });
                const result = await response.json();
                
                if (result.success) {
                    const d = result.data;
                    document.getElementById('positionResult').innerHTML = `
                        <div style="color: var(--accent-green);">
                            <strong>Recommended: ${d.recommended_lots} lot(s)</strong> (${d.shares} shares)
                        </div>
                        <div style="color: var(--text-secondary);">
                            Max Loss: â‚¹${d.max_loss.toFixed(0)} | Capital Required: â‚¹${d.capital_required.toFixed(0)}
                        </div>
                        <div style="font-size: 0.75rem; color: var(--text-secondary);">
                            Lot size: ${result.lot_size} shares
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Position calc error:', error);
            }
        }
        
        document.getElementById('expirySelect').addEventListener('change', fetchOptionChain);
        
        refreshData();
        setInterval(refreshData, 300000);
    </script>
</body>
</html>
