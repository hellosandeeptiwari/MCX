# ============================================================
#  Titan Trading Stack — Docker Compose
#  Start lean, add services as needed
#
#  Usage:
#    docker compose up -d titan-bot          # Bot only (Phase 1)
#    docker compose up -d                    # Full stack (Phase 2+)
#    docker compose logs -f titan-bot        # Watch bot logs
# ============================================================

services:

  # ── PHASE 1: Trading Bot (start here) ──
  titan-bot:
    build:
      context: .
      dockerfile: deploy/Dockerfile
    container_name: titan-bot
    restart: unless-stopped
    env_file: agentic_trader/.env
    volumes:
      - ./agentic_trader:/app/agentic_trader
      - titan-data:/app/agentic_trader/data
      - titan-logs:/app/agentic_trader/logs
    working_dir: /app/agentic_trader
    command: python autonomous_trader.py
    mem_limit: 512m
    cpus: 1.5
    healthcheck:
      test: ["CMD", "python", "-c", "import sqlite3; c=sqlite3.connect('titan_state.db'); c.execute('PRAGMA integrity_check'); c.close()"]
      interval: 5m
      timeout: 10s
      retries: 3

  # ── PHASE 2: Dashboard (enable when ready) ──
  titan-dashboard:
    build:
      context: .
      dockerfile: deploy/Dockerfile
    container_name: titan-dashboard
    restart: unless-stopped
    env_file: agentic_trader/.env
    volumes:
      - ./agentic_trader:/app/agentic_trader
      - titan-data:/app/agentic_trader/data:ro
      - titan-logs:/app/agentic_trader/logs:ro
    working_dir: /app/agentic_trader
    command: gunicorn --bind 0.0.0.0:5000 --workers 2 --timeout 60 dashboard:app
    ports:
      - "5000:5000"
    depends_on:
      - titan-bot
    profiles:
      - dashboard

  # ── PHASE 2: Nginx reverse proxy (HTTPS for dashboard) ──
  nginx:
    image: nginx:alpine
    container_name: titan-nginx
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./deploy/nginx-titan.conf:/etc/nginx/conf.d/default.conf:ro
      - nginx-certs:/etc/letsencrypt
    depends_on:
      - titan-dashboard
    profiles:
      - dashboard

  # ── PHASE 3: Grafana (advanced monitoring) ──
  grafana:
    image: grafana/grafana:latest
    container_name: titan-grafana
    restart: unless-stopped
    ports:
      - "3000:3000"
    volumes:
      - grafana-data:/var/lib/grafana
    environment:
      - GF_SECURITY_ADMIN_PASSWORD=${GRAFANA_PASSWORD:-titan2026}
      - GF_SERVER_ROOT_URL=http://localhost:3000
    profiles:
      - monitoring

volumes:
  titan-data:
  titan-logs:
  nginx-certs:
  grafana-data:
